```{r}
rm(list=ls())
```

```{r}
library(reshape2)
library(ggpubr)
library(readr)
library(knitr)
library(gridExtra)
library(DESeq2)
library(ggrepel)
library(org.Hs.eg.db)
library(AnnotationDbi)
library(tidyverse)
library(enrichplot)
library(clusterProfiler)
library(msigdbr)
library(GSVA)
library(ComplexHeatmap)
library(openxlsx)
library(stringr)
library(biomaRt)
library(msigdbr)
library(ReactomePA)
```

```{r}
rcounts <- read.csv("/Users/slothking/Desktop/Krappmann3/rcounts_merged.csv")
rownames(rcounts) <- rcounts$Row.names
rcounts <- rcounts %>% dplyr::select(-c(X, Row.names))
```


```{r}
cnt <- rcounts[(rowSums(rcounts)>0),] 
```

```{r}
genemap <- readRDS("/Users/slothking/Desktop/Krappmann3/genemap.RDS")

genemap <- genemap %>%
  dplyr::group_by(hgnc_symbol) %>%
  dplyr::mutate(n_unique_ensembl_id = n()) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(unique_gene_id = case_when(
    n_unique_ensembl_id > 1 ~ paste0(hgnc_symbol, "_", ensembl_gene_id_version), 
    .default = hgnc_symbol),
    ensembl_gene_id = str_remove(ensembl_gene_id_version, "\\..*$"))
```

```{r}
metadata <- read.xlsx("/Users/slothking/Desktop/Krappmann3/metadata.xlsx")
#We have two different sequencing rounds with the same samples. The rounds are annotated as 0207 and 0301. Make the coldata:
coldata_0207 <- metadata %>% dplyr::mutate(Sample_ID = paste0(str_replace_all(Sample_ID, "ample_24L0039", ""), "_0207"),
                                           Batch = "0207")
coldata_0301 <- metadata %>% dplyr::mutate(Sample_ID = paste0(str_replace_all(Sample_ID, "ample_24L0039", ""), "_0301"),
                                           Batch = "0301")
coldata <- bind_rows(coldata_0207, coldata_0301)
```

```{r}
coldata <- subset(coldata, Sample_Group %in% c("WT_TNF_UT", "WT_TNF_1H", 
                                               "EA_TNF_UT", "EA_TNF_1H",
                                               "CAEA_TNF_UT", "CAEA_TNF_1H"))

coldata <- subset(coldata, !Sample_ID %in% c("S55_0207", "S55_0301"))

coldata <- coldata %>% 
  dplyr::arrange(desc(Sample_Group)) %>%
  dplyr::group_by(Sample_Group) %>%
  dplyr::arrange(Sample_ID) %>%
  dplyr::ungroup()

rownames(coldata) <- coldata$Sample_ID

cnt <- dplyr::select(cnt, coldata$Sample_ID)
```

```{r}
cnt <- cnt[, rownames(coldata)]
all(rownames(coldata) %in% colnames(cnt))
all(rownames(coldata) == colnames(cnt))
```

```{r}
#Add the batch information as a confounder in the design parameter. This will account for the batch effect while calculating the differential expression analysis stats but won't normalize/transform the counts for the batch effect. We will do this later below.
dds <- DESeqDataSetFromMatrix(countData = cnt,
                              colData = coldata,
                              design = ~Batch+Sample_Group)
dds<- DESeq(dds)
```

```{r}
#Apply variance stabilizing transformation on the counts
vsd <- vst(dds, blind=FALSE)
vsdMat <- assay(vsd)
```

```{r}
#Calculate and visualize PCA with the batch effect

pcaData <- plotPCA(vsd, intgroup=c("Sample_Group", "Batch"), returnData=TRUE)
percentVar <- round(100 * attr(pcaData, "percentVar"))


pdf(file="TNFdataset/PCA_vst_WithBatchEffect_SampleGroups_TNFdataset.pdf", height=5, width=9)
ggplot(pcaData, aes(PC1, PC2, color=Sample_Group)) +
  geom_point(size=7) +
  xlab(paste0("PC1: ",percentVar[1],"% variance")) +
  theme(axis.title = element_text(size = 20))+
  ylab(paste0("PC2: ",percentVar[2],"% variance")) + 
  theme(axis.title = element_text(size = 20))+
  ggtitle("PCA With Batch Effect (TNF Dataset - Sample Groups)") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(),plot.background = element_blank(), axis.line = element_line(), plot.title = element_text(size=20))
dev.off()

pdf(file="TNFdataset/PCA_vst_WithBatchEffect_Batches_TNFdataset.pdf", height=5, width=9)
ggplot(pcaData, aes(PC1, PC2, color=Batch)) +
  geom_point(size=7) +
  xlab(paste0("PC1: ",percentVar[1],"% variance")) +
  theme(axis.title = element_text(size = 20))+
  ylab(paste0("PC2: ",percentVar[2],"% variance")) + 
  theme(axis.title = element_text(size = 20))+
  ggtitle("PCA With Batch Effect (TNF Dataset - Batches)") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(),plot.background = element_blank(), axis.line = element_line(), plot.title = element_text(size=20))
dev.off()
```

```{r}
#Correct for the batch effect on the variance stabilized counts for downstream analyses and count visualizations

assay(vsd) <- limma::removeBatchEffect(assay(vsd),
  batch = colData(dds)[,'Batch'])

vsdmelted_temp <- melt(vsdMat)
colnames(vsdmelted_temp) <- c("ensembl_gene_id_version", "Sample_ID", "Count")

vsdmelted <- merge(vsdmelted_temp, genemap, by = "ensembl_gene_id_version")
```

```{r}
#Calculate and visualize PCA after removing the batch effect

pcaData <- plotPCA(vsd, intgroup=c("Sample_Group", "Batch"), returnData=TRUE)
percentVar <- round(100 * attr(pcaData, "percentVar"))


pdf(file="TNFdataset/PCA_vst_BatchRemoved_SampleGroups_TNFdataset.pdf", height=5, width=9)
ggplot(pcaData, aes(PC1, PC2, color=Sample_Group)) +
  geom_point(size=7) +
  xlab(paste0("PC1: ",percentVar[1],"% variance")) +
  theme(axis.title = element_text(size = 20))+
  ylab(paste0("PC2: ",percentVar[2],"% variance")) + 
  theme(axis.title = element_text(size = 20))+
  ggtitle("PCA Without Batch Effect (TNF Dataset - Sample Groups)") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(),plot.background = element_blank(), axis.line = element_line(), plot.title = element_text(size=20))
dev.off()

pdf(file="TNFdataset/PCA_vst_BatchRemoved_Batches_TNFdataset.pdf", height=5, width=9)
ggplot(pcaData, aes(PC1, PC2, color=Batch)) +
  geom_point(size=7) +
  xlab(paste0("PC1: ",percentVar[1],"% variance")) +
  theme(axis.title = element_text(size = 20))+
  ylab(paste0("PC2: ",percentVar[2],"% variance")) + 
  theme(axis.title = element_text(size = 20))+
  ggtitle("PCA Without Batch Effect (TNF Dataset - Batches)") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(),plot.background = element_blank(), axis.line = element_line(), plot.title = element_text(size=20))
dev.off()
```

```{r}
res_wt_TNFvsUT <- DESeq2::results(dds, contrast=c("Sample_Group","WT_TNF_1H","WT_TNF_UT"), alpha = 0.05)
summary(res_wt_TNFvsUT)

wt_TNFvsUT_list<-data.frame(gene = rownames(res_wt_TNFvsUT), res_wt_TNFvsUT, stringsAsFactors = F) %>% 
  na.omit() %>% 
  dplyr::select("log2FoldChange", "padj") %>% 
  tibble::rownames_to_column(var = "ensembl_gene_id_version") %>% 
  dplyr::mutate(padj = case_when(padj == 0 ~ .Machine$double.xmin,
                                TRUE ~ padj), 
                signed_padj = sign(log2FoldChange)*-log10(padj),
                minuslogp = -log10(padj)) %>%
  merge(genemap, by="ensembl_gene_id_version") %>%
  dplyr::arrange(desc(signed_padj)) 

wt_TNFvsUT_pos <- subset(wt_TNFvsUT_list, signed_padj > 0) %>%
  arrange(signed_padj, abs(log2FoldChange)) %>%
  mutate(rank = row_number()) %>%
  arrange(desc(rank))

wt_TNFvsUT_neg <- subset(wt_TNFvsUT_list, signed_padj < 0) %>%
  arrange(desc(signed_padj), abs(log2FoldChange)) %>%
  mutate(rank = -row_number()) %>%
  arrange(desc(rank))

wt_TNFvsUT_list <- bind_rows(wt_TNFvsUT_pos, wt_TNFvsUT_neg) %>% dplyr::arrange(desc(rank))

write.xlsx(wt_TNFvsUT_list, "TNFdataset/wt_TNFvsUT.xlsx")
```

```{r}
res_ea_TNFvsUT <- DESeq2::results(dds, contrast=c("Sample_Group","EA_TNF_1H","EA_TNF_UT"), alpha = 0.05)
summary(res_ea_TNFvsUT)

ea_TNFvsUT_list<-data.frame(gene = rownames(res_ea_TNFvsUT), res_ea_TNFvsUT, stringsAsFactors = F) %>% 
  na.omit() %>% 
  dplyr::select("log2FoldChange", "padj") %>% 
  tibble::rownames_to_column(var = "ensembl_gene_id_version") %>% 
  dplyr::mutate(padj = case_when(padj == 0 ~ .Machine$double.xmin,
                                TRUE ~ padj), 
                signed_padj = sign(log2FoldChange)*-log10(padj),
                minuslogp = -log10(padj)) %>%
  merge(genemap, by="ensembl_gene_id_version") %>%
  dplyr::arrange(desc(signed_padj)) 

ea_TNFvsUT_pos <- subset(ea_TNFvsUT_list, signed_padj > 0) %>%
  arrange(signed_padj, abs(log2FoldChange)) %>%
  mutate(rank = row_number()) %>%
  arrange(desc(rank))

ea_TNFvsUT_neg <- subset(ea_TNFvsUT_list, signed_padj < 0) %>%
  arrange(desc(signed_padj), abs(log2FoldChange)) %>%
  mutate(rank = -row_number()) %>%
  arrange(desc(rank))

ea_TNFvsUT_list <- bind_rows(ea_TNFvsUT_pos, ea_TNFvsUT_neg) %>% dplyr::arrange(desc(rank))

write.xlsx(ea_TNFvsUT_list, "TNFdataset/ea_TNFvsUT.xlsx")
```
```{r}
res_caea_TNFvsUT <- DESeq2::results(dds, contrast=c("Sample_Group","CAEA_TNF_1H","CAEA_TNF_UT"), alpha = 0.05)
summary(res_caea_TNFvsUT)

caea_TNFvsUT_list<-data.frame(gene = rownames(res_caea_TNFvsUT), res_caea_TNFvsUT, stringsAsFactors = F) %>% 
  na.omit() %>% 
  dplyr::select("log2FoldChange", "padj") %>% 
  tibble::rownames_to_column(var = "ensembl_gene_id_version") %>% 
  dplyr::mutate(padj = case_when(padj == 0 ~ .Machine$double.xmin,
                                TRUE ~ padj), 
                signed_padj = sign(log2FoldChange)*-log10(padj),
                minuslogp = -log10(padj)) %>%
  merge(genemap, by="ensembl_gene_id_version") %>%
  dplyr::arrange(desc(signed_padj)) 

caea_TNFvsUT_pos <- subset(caea_TNFvsUT_list, signed_padj > 0) %>%
  arrange(signed_padj, abs(log2FoldChange)) %>%
  mutate(rank = row_number()) %>%
  arrange(desc(rank))

caea_TNFvsUT_neg <- subset(caea_TNFvsUT_list, signed_padj < 0) %>%
  arrange(desc(signed_padj), abs(log2FoldChange)) %>%
  mutate(rank = -row_number()) %>%
  arrange(desc(rank))

caea_TNFvsUT_list <- bind_rows(caea_TNFvsUT_pos, caea_TNFvsUT_neg) %>% dplyr::arrange(desc(rank))

write.xlsx(caea_TNFvsUT_list, "TNFdataset/caea_TNFvsUT.xlsx")
```
```{r}
# selected_genes <- unique(intersect(
#   intersect(subset(wt_TNFvsUT_list, abs(log2FoldChange) >= 0.5 & padj <= 0.05)$ensembl_gene_id_version,
#             subset(ea_TNFvsUT_list, abs(log2FoldChange) >= 0.5 & padj <= 0.05)$ensembl_gene_id_version),
#   subset(caea_TNFvsUT_list, abs(log2FoldChange) >= 0.5 & padj <= 0.05)$ensembl_gene_id_version))

tnfUP_signature <- subset(wt_TNFvsUT_list, log2FoldChange >= 0.5 & padj <= 0.001)$ensembl_gene_id_version
saveRDS(tnfUP_signature, "tnfUP_signature.RDS")

selected_genes <- tnfUP_signature
```


```{r}
data_heatmap <- subset(vsdMat, rownames(vsdMat) %in% selected_genes)

scaled_data = t(scale(t(data_heatmap)))

ordered_data <- as.data.frame(scaled_data[,coldata$Sample_ID])

ordered_data$ensembl_gene_id_version <- rownames(ordered_data)

ordered_data_temp <- merge(ordered_data, genemap, by="ensembl_gene_id_version")

rownames(ordered_data_temp) <-ordered_data_temp$unique_gene_id

ordered_data <- ordered_data_temp[,coldata$Sample_ID]

group_labels <- factor(coldata$Sample_Group)
group_labels_unique <- unique(group_labels)
group_colors <- c("#FF5733", "#33FF57", "#337AFF", "#FF33E9", "#FFD700", "#800080")
names(group_colors) <- group_labels_unique



column_annotation <- HeatmapAnnotation(
  group = group_labels,
  col = list(group = group_colors)
)


pdf("TNFdataset/Heatmap_TNFdataset.pdf", width = 6, height = 4)
Heatmap(ordered_data, 
        name = "Expression", 
        show_row_names = TRUE, 
        show_column_names = TRUE,
        cluster_columns = FALSE,
        cluster_rows = TRUE,
        row_names_gp = gpar(fontsize = 5),
        top_annotation = column_annotation,
        column_names_gp = gpar(fontsize = 4))
dev.off()
```

```{r}
reactome_genesets <- msigdbr(species = "Homo sapiens", 
                             category = "C2", 
                             subcategory = "CP:REACTOME") %>% 
  dplyr::select(gs_name, ensembl_gene) %>% distinct()

go_genesets <- msigdbr(species = "Homo sapiens", 
                             category = "C5", 
                             subcategory = "GO:BP") %>% 
  dplyr::select(gs_name, ensembl_gene) %>% distinct()

tft_genesets_legacy <- msigdbr(species = "Homo sapiens", 
                             category = "C3",
                             subcategory = "TFT:TFT_Legacy") %>% 
  dplyr::select(gs_name, ensembl_gene) %>% distinct()

tft_genesets_gtrd <- msigdbr(species = "Homo sapiens", 
                             category = "C3",
                             subcategory = "TFT:GTRD") %>% 
  dplyr::select(gs_name, ensembl_gene) %>% distinct()

tft_genesets <- bind_rows(tft_genesets_legacy, tft_genesets_gtrd)

reactome_genesets_subset <- reactome_genesets %>% 
  subset(gs_name %in% c("REACTOME_TNFR2_NON_CANONICAL_NF_KB_PATHWAY",
                        "REACTOME_NF_KB_IS_ACTIVATED_AND_SIGNALS_SURVIVAL"))

tft_genesets_subset <- tft_genesets %>% 
  subset(gs_name %in% c("NFKBIA_TARGET_GENES"))
```

```{r}
wt_TNFvsUT_ranked<-wt_TNFvsUT_list$rank
names(wt_TNFvsUT_ranked)<-str_remove(wt_TNFvsUT_list$ensembl_gene_id_version, "\\..*$")

reac_enrich_wt_TNFvsUT_GSEAobject <- GSEA(wt_TNFvsUT_ranked, 
                                          TERM2GENE = reactome_genesets, 
                                          eps = 0, 
                                          pvalueCutoff = 0.25, 
                                          nPermSimple = 1e4)
reac_enrich_wt_TNFvsUT_GSEAobject <- setReadable(reac_enrich_wt_TNFvsUT_GSEAobject, 'org.Hs.eg.db', 'ENSEMBL')
reac_enrich_wt_TNFvsUT <- reac_enrich_wt_TNFvsUT_GSEAobject@result %>%
  dplyr::mutate(signed_padj = sign(NES)*-log10(p.adjust)) %>%
  dplyr::arrange(desc(signed_padj))

tft_enrich_wt_TNFvsUT_GSEAobject <- GSEA(wt_TNFvsUT_ranked, 
                                         TERM2GENE = tft_genesets, 
                                         eps = 0, 
                                         pvalueCutoff = 0.25, 
                                         nPermSimple = 1e4)
tft_enrich_wt_TNFvsUT_GSEAobject <- setReadable(tft_enrich_wt_TNFvsUT_GSEAobject, 'org.Hs.eg.db', 'ENSEMBL')
tft_enrich_wt_TNFvsUT <- tft_enrich_wt_TNFvsUT_GSEAobject@result %>%
  dplyr::mutate(signed_padj = sign(NES)*-log10(p.adjust)) %>%
  dplyr::arrange(desc(signed_padj))

#saveRDS(reac_enrich_wt_TNFvsUT_GSEAobject, "TNFdataset/GSEA/reac_enrich_wt_TNFvsUT_GSEAobject.RDS")
#saveRDS(tft_enrich_wt_TNFvsUT_GSEAobject, "TNFdataset/GSEA/tft_enrich_wt_TNFvsUT_GSEAobject.RDS")
```

```{r}
ea_TNFvsUT_ranked<-ea_TNFvsUT_list$rank
names(ea_TNFvsUT_ranked)<-str_remove(ea_TNFvsUT_list$ensembl_gene_id_version, "\\..*$")

reac_enrich_ea_TNFvsUT_GSEAobject <- GSEA(ea_TNFvsUT_ranked,
                                          TERM2GENE = reactome_genesets, 
                                          eps = 0, 
                                          pvalueCutoff = 0.25, 
                                          nPermSimple = 1e4)
reac_enrich_ea_TNFvsUT_GSEAobject <- setReadable(reac_enrich_ea_TNFvsUT_GSEAobject, 'org.Hs.eg.db', 'ENSEMBL')
reac_enrich_ea_TNFvsUT <- reac_enrich_ea_TNFvsUT_GSEAobject@result %>%
  dplyr::mutate(signed_padj = sign(NES)*-log10(p.adjust)) %>%
  dplyr::arrange(desc(signed_padj))

tft_enrich_ea_TNFvsUT_GSEAobject <- GSEA(ea_TNFvsUT_ranked, 
                                         TERM2GENE = tft_genesets, 
                                         eps = 0, 
                                         pvalueCutoff = 0.25, 
                                         nPermSimple = 1e4)
tft_enrich_ea_TNFvsUT_GSEAobject <- setReadable(tft_enrich_ea_TNFvsUT_GSEAobject, 'org.Hs.eg.db', 'ENSEMBL')
tft_enrich_ea_TNFvsUT <- tft_enrich_ea_TNFvsUT_GSEAobject@result %>%
  dplyr::mutate(signed_padj = sign(NES)*-log10(p.adjust)) %>%
  dplyr::arrange(desc(signed_padj))

#saveRDS(reac_enrich_ea_TNFvsUT_GSEAobject, "TNFdataset/GSEA/reac_enrich_ea_TNFvsUT_GSEAobject.RDS")
#saveRDS(tft_enrich_ea_TNFvsUT_GSEAobject, "TNFdataset/GSEA/tft_enrich_ea_TNFvsUT_GSEAobject.RDS")
```

```{r}
caea_TNFvsUT_ranked<-caea_TNFvsUT_list$rank
names(caea_TNFvsUT_ranked)<-str_remove(caea_TNFvsUT_list$ensembl_gene_id_version, "\\..*$")

reac_enrich_caea_TNFvsUT_GSEAobject <- GSEA(caea_TNFvsUT_ranked, 
                                            TERM2GENE = reactome_genesets, 
                                            eps = 0, 
                                            pvalueCutoff = 0.25, 
                                            nPermSimple = 1e4)
reac_enrich_caea_TNFvsUT_GSEAobject <- setReadable(reac_enrich_caea_TNFvsUT_GSEAobject, 'org.Hs.eg.db', 'ENSEMBL')
reac_enrich_caea_TNFvsUT <- reac_enrich_caea_TNFvsUT_GSEAobject@result %>%
  dplyr::mutate(signed_padj = sign(NES)*-log10(p.adjust)) %>%
  dplyr::arrange(desc(signed_padj))

tft_enrich_caea_TNFvsUT_GSEAobject <- GSEA(caea_TNFvsUT_ranked, 
                                           TERM2GENE = tft_genesets, 
                                           eps = 0, 
                                           pvalueCutoff = 0.25, 
                                           nPermSimple = 1e4)
tft_enrich_caea_TNFvsUT_GSEAobject <- setReadable(tft_enrich_caea_TNFvsUT_GSEAobject, 'org.Hs.eg.db', 'ENSEMBL')
tft_enrich_caea_TNFvsUT <- tft_enrich_caea_TNFvsUT_GSEAobject@result %>%
  dplyr::mutate(signed_padj = sign(NES)*-log10(p.adjust)) %>%
  dplyr::arrange(desc(signed_padj))

#saveRDS(reac_enrich_caea_TNFvsUT_GSEAobject, "TNFdataset/GSEA/reac_enrich_caea_TNFvsUT_GSEAobject.RDS")
#saveRDS(tft_enrich_caea_TNFvsUT_GSEAobject, "TNFdataset/GSEA/tft_enrich_caea_TNFvsUT_GSEAobject.RDS")
```

```{r}
reactome_list <- unlist(split(reactome_genesets_subset, 
                              f = reactome_genesets_subset$gs_name), 
                        recursive = F)

vsdMat_ensembl <- vsdMat
rownames(vsdMat_ensembl) <- str_remove(rownames(vsdMat), "\\..*$")

gsva_object <- gsvaParam(exprData = as.matrix(vsdMat_ensembl), geneSets = reactome_list)
gsva_res_reactome <- gsva(gsva_object, verbose=FALSE)

gsva_res_reactome_melted <- reshape2::melt(gsva_res_reactome, 
                                           varnames=c('GeneSet', 'Sample_ID'),
                                           value.name = "GSVAscore") %>%
  dplyr::mutate(GeneSet = str_remove_all(GeneSet, ".gene_symbol"),
                GeneSet = str_remove_all(GeneSet, "REACTOME_"))

gsva_res_reactome_merged <- merge(gsva_res_reactome_melted, coldata, by="Sample_ID")

gsva_res_reactome_merged$Sample_Group <- factor(gsva_res_reactome_merged$Sample_Group, levels =
                                                                   c("WT_TNF_UT", "WT_TNF_1H", 
                                                                     "EA_TNF_UT","EA_TNF_1H",
                                                                     "CAEA_TNF_UT", "CAEA_TNF_1H"))

gsva_res_reactome_merged <- gsva_res_reactome_merged %>% arrange(Sample_Group) %>% dplyr::mutate(GeneSet = str_replace_all(GeneSet, ".ensembl_gene", ""))

# Define group colors
group_colors <- c("WT_TNF_UT" = "#FF5733",
                  "WT_TNF_1H" = "#33FF57",
                  "EA_TNF_UT" = "#337AFF",
                  "EA_TNF_1H" = "#FF33E9",
                  "CAEA_TNF_UT" = "#FFD700",
                  "CAEA_TNF_1H" = "#800080")

# Calculate means for each SampleGroup
median <- gsva_res_reactome_merged %>%
  group_by(Sample_Group, GeneSet) %>%
  summarize(median_GSVAscore = median(GSVAscore))

pdf("TNFdataset/GSVAexample.pdf", width = 4, height = 8)
ggplot(gsva_res_reactome_merged, aes(y = GSVAscore, x = Sample_Group, color = Sample_Group)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.1) +
  scale_color_manual(values = group_colors) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
        strip.text = element_text(size = 4),
        legend.position = "none") +
  facet_wrap(~GeneSet, ncol = 1, nrow=2)
dev.off()
```

```{r}
# Wilcoxon test for GSVA (NFKB Survival Pathway)
wt_TNF_survival <- subset(gsva_res_reactome_merged, Sample_Group == "WT_TNF_1H" & 
                            GeneSet == "NF_KB_IS_ACTIVATED_AND_SIGNALS_SURVIVAL")$GSVAscore
wt_UT_survival <- subset(gsva_res_reactome_merged, Sample_Group == "WT_TNF_UT" & 
                            GeneSet == "NF_KB_IS_ACTIVATED_AND_SIGNALS_SURVIVAL")$GSVAscore

res_wt_survival <- wilcox.test(wt_TNF_survival, wt_UT_survival, correct = TRUE)
res_wt_survival

ea_TNF_survival <- subset(gsva_res_reactome_merged, Sample_Group == "EA_TNF_1H" & 
                            GeneSet == "NF_KB_IS_ACTIVATED_AND_SIGNALS_SURVIVAL")$GSVAscore
ea_UT_survival <- subset(gsva_res_reactome_merged, Sample_Group == "EA_TNF_UT" & 
                            GeneSet == "NF_KB_IS_ACTIVATED_AND_SIGNALS_SURVIVAL")$GSVAscore

res_ea_survival <- wilcox.test(ea_TNF_survival, ea_UT_survival, correct = TRUE)
res_ea_survival

caea_TNF_survival <- subset(gsva_res_reactome_merged, Sample_Group == "CAEA_TNF_1H" & 
                            GeneSet == "NF_KB_IS_ACTIVATED_AND_SIGNALS_SURVIVAL")$GSVAscore
caea_UT_survival <- subset(gsva_res_reactome_merged, Sample_Group == "CAEA_TNF_UT" & 
                            GeneSet == "NF_KB_IS_ACTIVATED_AND_SIGNALS_SURVIVAL")$GSVAscore

res_caea_survival <- wilcox.test(caea_TNF_survival, caea_UT_survival, correct = TRUE)
res_caea_survival
```
```{r}
# Independence test for GSVA (NFKB Survival Pathway)
wt_TNF_survival <- subset(gsva_res_reactome_merged, Sample_Group %in% 
                                      c("WT_TNF_1H",  "WT_TNF_UT") &
                                      GeneSet == "NF_KB_IS_ACTIVATED_AND_SIGNALS_SURVIVAL")
ea_TNF_survival <- subset(gsva_res_reactome_merged, Sample_Group %in% 
                                      c("EA_TNF_1H",  "EA_TNF_UT") &
                                      GeneSet == "NF_KB_IS_ACTIVATED_AND_SIGNALS_SURVIVAL")
caea_TNF_survival <- subset(gsva_res_reactome_merged, Sample_Group %in% 
                                      c("CAEA_TNF_1H",  "CAEA_TNF_UT") &
                                      GeneSet == "NF_KB_IS_ACTIVATED_AND_SIGNALS_SURVIVAL")

res_wt_TNF_survival <- independence_test(wt_TNF_survival$GSVAscore ~
                                                     factor(wt_TNF_survival$Sample_Group, 
                                                            levels = c("WT_TNF_1H", "WT_TNF_UT")),
                                                   distribution = "exact",
                                                   alternative = "greater")
res_wt_TNF_survival

res_ea_TNF_survival <- independence_test(ea_TNF_survival$GSVAscore ~
                                                     factor(ea_TNF_survival$Sample_Group, 
                                                            levels = c("EA_TNF_1H", "EA_TNF_UT")),
                                                   distribution = "exact",
                                                   alternative = "greater")
res_ea_TNF_survival

res_caea_TNF_survival <- independence_test(caea_TNF_survival$GSVAscore ~
                                                     factor(caea_TNF_survival$Sample_Group, 
                                                            levels = c("CAEA_TNF_1H", "CAEA_TNF_UT")),
                                                   distribution = "exact",
                                                   alternative = "greater")
res_caea_TNF_survival
```

```{r}
# Wilcoxon test for GSVA (TNFR2 Non Canonical NFKB Pathway)
wt_TNF_noncanonical <- subset(gsva_res_reactome_merged, Sample_Group == "WT_TNF_1H" & 
                            GeneSet == "TNFR2_NON_CANONICAL_NF_KB_PATHWAY")$GSVAscore
wt_UT_noncanonical <- subset(gsva_res_reactome_merged, Sample_Group == "WT_TNF_UT" & 
                            GeneSet == "TNFR2_NON_CANONICAL_NF_KB_PATHWAY")$GSVAscore

res_wt_noncanonical <- wilcox.test(wt_TNF_noncanonical, wt_UT_noncanonical, correct = TRUE)
res_wt_noncanonical

ea_TNF_noncanonical <- subset(gsva_res_reactome_merged, Sample_Group == "EA_TNF_1H" & 
                            GeneSet == "TNFR2_NON_CANONICAL_NF_KB_PATHWAY")$GSVAscore
ea_UT_noncanonical <- subset(gsva_res_reactome_merged, Sample_Group == "EA_TNF_UT" & 
                            GeneSet == "TNFR2_NON_CANONICAL_NF_KB_PATHWAY")$GSVAscore

res_ea_noncanonical <- wilcox.test(ea_TNF_noncanonical, ea_UT_noncanonical, correct = TRUE)
res_ea_noncanonical

caea_TNF_noncanonical <- subset(gsva_res_reactome_merged, Sample_Group == "CAEA_TNF_1H" & 
                            GeneSet == "TNFR2_NON_CANONICAL_NF_KB_PATHWAY")$GSVAscore
caea_UT_noncanonical <- subset(gsva_res_reactome_merged, Sample_Group == "CAEA_TNF_UT" & 
                            GeneSet == "TNFR2_NON_CANONICAL_NF_KB_PATHWAY")$GSVAscore

res_caea_noncanonical <- wilcox.test(caea_TNF_noncanonical, caea_UT_noncanonical, correct = TRUE)
res_caea_noncanonical
```
```{r}
# Independence test for GSVA TNFR2_NON_CANONICAL_NF_KB_PATHWAY
wt_TNF_noncanonical <- subset(gsva_res_reactome_merged, Sample_Group %in% 
                                      c("WT_TNF_1H",  "WT_TNF_UT") &
                                      GeneSet == "TNFR2_NON_CANONICAL_NF_KB_PATHWAY")
ea_TNF_noncanonical <- subset(gsva_res_reactome_merged, Sample_Group %in% 
                                      c("EA_TNF_1H",  "EA_TNF_UT") &
                                      GeneSet == "TNFR2_NON_CANONICAL_NF_KB_PATHWAY")
caea_TNF_noncanonical <- subset(gsva_res_reactome_merged, Sample_Group %in% 
                                      c("CAEA_TNF_1H",  "CAEA_TNF_UT") &
                                      GeneSet == "TNFR2_NON_CANONICAL_NF_KB_PATHWAY")

res_wt_TNF_noncanonical <- independence_test(wt_TNF_noncanonical$GSVAscore ~
                                                     factor(wt_TNF_noncanonical$Sample_Group, 
                                                            levels = c("WT_TNF_1H", "WT_TNF_UT")),
                                                   distribution = "exact",
                                                   alternative = "greater")
res_wt_TNF_noncanonical

res_ea_TNF_noncanonical <- independence_test(ea_TNF_noncanonical$GSVAscore ~
                                                     factor(ea_TNF_noncanonical$Sample_Group, 
                                                            levels = c("EA_TNF_1H", "EA_TNF_UT")),
                                                   distribution = "exact",
                                                   alternative = "greater")
res_ea_TNF_noncanonical

res_caea_TNF_noncanonical <- independence_test(caea_TNF_noncanonical$GSVAscore ~
                                                     factor(caea_TNF_noncanonical$Sample_Group, 
                                                            levels = c("CAEA_TNF_1H", "CAEA_TNF_UT")),
                                                   distribution = "exact",
                                                   alternative = "greater")
res_caea_TNF_noncanonical
```

```{r}
canonical_nfkb_genes <- subset(reactome_genesets, gs_name == "REACTOME_NF_KB_IS_ACTIVATED_AND_SIGNALS_SURVIVAL")$ensembl_gene

data_heatmap <- subset(vsdMat, str_remove(rownames(vsdMat), "\\..*$") %in% canonical_nfkb_genes)

scaled_data = na.omit(t(scale(t(data_heatmap)))) 

ordered_data <- as.data.frame(scaled_data[,coldata$Sample_ID])

ordered_data$ensembl_gene_id_version <- rownames(ordered_data)

ordered_data_temp <- merge(ordered_data, genemap, by="ensembl_gene_id_version")

rownames(ordered_data_temp) <-ordered_data_temp$unique_gene_id

ordered_data <- ordered_data_temp[,coldata$Sample_ID]

group_labels <- factor(coldata$Sample_Group)
group_labels_unique <- unique(group_labels)
group_colors <- c("#FF5733", "#33FF57", "#337AFF", "#FF33E9", "#FFD700", "#800080")
names(group_colors) <- group_labels_unique



column_annotation <- HeatmapAnnotation(
  group = group_labels,
  col = list(group = group_colors)
)


pdf("TNFdataset/Heatmap_TNFdataset_CanonicalNFKB.pdf", width = 6, height = 2)
Heatmap(ordered_data, 
        name = "Expression", 
        show_row_names = TRUE, 
        show_column_names = TRUE,
        cluster_columns = FALSE,
        cluster_rows = TRUE,
        row_names_gp = gpar(fontsize = 5),
        top_annotation = column_annotation,
        column_names_gp = gpar(fontsize = 4))
dev.off()
```

```{r}
tnf_superfamily_nfkb_genes <- subset(reactome_genesets, gs_name == "REACTOME_TNF_RECEPTOR_SUPERFAMILY_TNFSF_MEMBERS_MEDIATING_NON_CANONICAL_NF_KB_PATHWAY")$ensembl_gene

data_heatmap <- subset(vsdMat, str_remove(rownames(vsdMat), "\\..*$") %in% tnf_superfamily_nfkb_genes)

scaled_data = na.omit(t(scale(t(data_heatmap)))) 

ordered_data <- as.data.frame(scaled_data[,coldata$Sample_ID])

ordered_data$ensembl_gene_id_version <- rownames(ordered_data)

ordered_data_temp <- merge(ordered_data, genemap, by="ensembl_gene_id_version")

rownames(ordered_data_temp) <-ordered_data_temp$unique_gene_id

ordered_data <- ordered_data_temp[,coldata$Sample_ID]

group_labels <- factor(coldata$Sample_Group)
group_labels_unique <- unique(group_labels)
group_colors <- c("#FF5733", "#33FF57", "#337AFF", "#FF33E9", "#FFD700", "#800080")
names(group_colors) <- group_labels_unique



column_annotation <- HeatmapAnnotation(
  group = group_labels,
  col = list(group = group_colors)
)


pdf("TNFdataset/Heatmap_TNFdataset_TNFsuperfamilyNFKB.pdf", width = 6, height = 2)
Heatmap(ordered_data, 
        name = "Expression", 
        show_row_names = TRUE, 
        show_column_names = TRUE,
        cluster_columns = FALSE,
        cluster_rows = TRUE,
        row_names_gp = gpar(fontsize = 5),
        top_annotation = column_annotation,
        column_names_gp = gpar(fontsize = 4))
dev.off()
```

```{r}
tnfr2_noncanonical_nfkb_genes <- subset(reactome_genesets, gs_name == "REACTOME_TNFR2_NON_CANONICAL_NF_KB_PATHWAY")$ensembl_gene

data_heatmap <- subset(vsdMat, str_remove(rownames(vsdMat), "\\..*$") %in% tnfr2_noncanonical_nfkb_genes)

scaled_data = na.omit(t(scale(t(data_heatmap)))) 

ordered_data <- as.data.frame(scaled_data[,coldata$Sample_ID])

ordered_data$ensembl_gene_id_version <- rownames(ordered_data)

ordered_data_temp <- merge(ordered_data, genemap, by="ensembl_gene_id_version")

rownames(ordered_data_temp) <-ordered_data_temp$unique_gene_id

ordered_data <- ordered_data_temp[,coldata$Sample_ID]

group_labels <- factor(coldata$Sample_Group)
group_labels_unique <- unique(group_labels)
group_colors <- c("#FF5733", "#33FF57", "#337AFF", "#FF33E9", "#FFD700", "#800080")
names(group_colors) <- group_labels_unique



column_annotation <- HeatmapAnnotation(
  group = group_labels,
  col = list(group = group_colors)
)


pdf("TNFdataset/Heatmap_TNFdataset_TNFR2noncanonicalNFKB.pdf", width = 6, height = 7)
Heatmap(ordered_data, 
        name = "Expression", 
        show_row_names = TRUE, 
        show_column_names = TRUE,
        cluster_columns = FALSE,
        cluster_rows = TRUE,
        row_names_gp = gpar(fontsize = 5),
        top_annotation = column_annotation,
        column_names_gp = gpar(fontsize = 4))
dev.off()
```

```{r}
vsd_counts_melted_selectedgenes <- subset(vsdmelted, ensembl_gene_id_version %in% selected_genes)

vsd_counts_melted_selectedgenes_annotated <- merge(vsd_counts_melted_selectedgenes, coldata, by="Sample_ID") 

vsd_counts_melted_selectedgenes_annotated$Sample_Group <- factor(vsd_counts_melted_selectedgenes_annotated$Sample_Group, levels =
                                                                   c("WT_TNF_UT", "WT_TNF_1H", 
                                                                     "EA_TNF_UT","EA_TNF_1H",
                                                                     "CAEA_TNF_UT", "CAEA_TNF_1H"))

vsd_counts_melted_selectedgenes_annotated <- vsd_counts_melted_selectedgenes_annotated %>% arrange(Sample_Group)

#Not actually subsetting here because we are choosing the entire dataset but this is how to subset in case if it is needed.
vsd_counts_melted_selectedgenes_annotated_subset <- subset(vsd_counts_melted_selectedgenes_annotated, Sample_Group %in%
                                                             c("WT_TNF_UT", "WT_TNF_1H", 
                                                               "EA_TNF_UT","EA_TNF_1H",
                                                               "CAEA_TNF_UT", "CAEA_TNF_1H"))


# Start a new PDF file with 1 plot per page
pdf("TNFdataset/gene_boxplots_TNFdataset.pdf", width = 1.8, height=3)

# Loop over each gene and create a plot on a new page
for (g in unique(vsd_counts_melted_selectedgenes_annotated_subset$ensembl_gene_id_version)) {
  # Subset the data for the current gene
  gene_data <- subset(vsd_counts_melted_selectedgenes_annotated_subset, ensembl_gene_id_version == g)
  # Create the plot for the current gene
  p <- ggplot(gene_data, aes(x = Sample_Group, y = Count, color = Sample_Group)) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(width = 0.1) +
    scale_color_manual(values=c("WT_TNF_UT" = "#FF5733",
                                "WT_TNF_1H" = "#33FF57",
                                "EA_TNF_UT" = "#337AFF",
                                "EA_TNF_1H" = "#FF33E9",
                                "CAEA_TNF_UT" = "#FFD700",
                                "CAEA_TNF_1H" = "#800080")) +
    ylab("Normalized Count") +
    ggtitle(paste(gene_data$unique_gene_id)) +
    theme_bw() +
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          plot.background = element_blank(), 
          axis.line = element_line(), 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
          plot.title = element_text(size=6),
          axis.title.x = element_blank(),
          axis.title.y = element_text(size=10))+
    # theme(axis.title.x = element_blank(),
    #       axis.ticks.x = element_blank(),
    #       strip.background = element_blank(),
    #       strip.placement = "outside",
    #       strip.text = element_text(size = 10, face = "bold"),
    #       axis.text.x = element_text(angle = 90))+ 
    guides(color="none")
  
  # Print the plot for the current gene on a new page
  print(p)
}

# Close the PDF file
dev.off()
```

### VOLCANO PLOTS ###

```{r}
pdf(file="TNFdataset/Volcano_wt_TNFvsUT.pdf", width=6, height=6)
ggplot(wt_TNFvsUT_list, aes(x=log2FoldChange, y=(minuslogp)))+
  geom_point(size=2.25,color="grey", alpha=0.3)+
  geom_point(data=subset(wt_TNFvsUT_list, minuslogp > 18), size=3,color="darkred", alpha=0.6)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(),plot.background = element_blank(), axis.line = element_line()) +
  xlab("Log2FoldChange")+
  theme(axis.title = element_text(size = 12, face = "bold"), axis.text=element_text(size=10, face = "bold"))+
  ylab("-log10(p-adj)")+
  theme(axis.title = element_text(size = 12, face = "bold"), axis.text=element_text(size=10, face = "bold"))+
  geom_text_repel(data=subset(wt_TNFvsUT_list, minuslogp > 18), aes(label=unique_gene_id),
                  size=4,
                  color="black",
                  nudge_y = 1,
                  force=10,
                  min.segment.length = 0,
                  max.overlaps = Inf)+
  scale_y_continuous(breaks = seq(0,325,by=25), limits = c(0,325))+
  scale_x_continuous(breaks = seq(-3,3,by=1), limits = c(-3.2,3.2))
dev.off()
```

```{r}
pdf(file="TNFdataset/Volcano_ea_TNFvsUT.pdf", width=6, height=6)
ggplot(ea_TNFvsUT_list, aes(x=log2FoldChange, y=(minuslogp)))+
  geom_point(size=2.25,color="grey", alpha=0.3)+
  geom_point(data=subset(ea_TNFvsUT_list, minuslogp > 18), size=3,color="darkred", alpha=0.6)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(),plot.background = element_blank(), axis.line = element_line()) +
  xlab("Log2FoldChange")+
  theme(axis.title = element_text(size = 12, face = "bold"), axis.text=element_text(size=10, face = "bold"))+
  ylab("-log10(p-adj)")+
  theme(axis.title = element_text(size = 12, face = "bold"), axis.text=element_text(size=10, face = "bold"))+
  geom_text_repel(data=subset(ea_TNFvsUT_list, minuslogp > 18), aes(label=unique_gene_id),
                  size=4,
                  color="black",
                  nudge_y = 1,
                  force=10,
                  min.segment.length = 0,
                  max.overlaps = Inf)+
  scale_y_continuous(breaks = seq(0,325,by=25), limits = c(0,325))+
  scale_x_continuous(breaks = seq(-3,3,by=1), limits = c(-3.2,3.2))
dev.off()
```

```{r}
pdf(file="TNFdataset/Volcano_caea_TNFvsUT.pdf", width=6, height=6)
ggplot(caea_TNFvsUT_list, aes(x=log2FoldChange, y=(minuslogp)))+
  geom_point(size=2.25,color="grey", alpha=0.3)+
  geom_point(data=subset(caea_TNFvsUT_list, minuslogp > 18), size=3,color="darkred", alpha=0.6)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(),plot.background = element_blank(), axis.line = element_line()) +
  xlab("Log2FoldChange")+
  theme(axis.title = element_text(size = 12, face = "bold"), axis.text=element_text(size=10, face = "bold"))+
  ylab("-log10(p-adj)")+
  theme(axis.title = element_text(size = 12, face = "bold"), axis.text=element_text(size=10, face = "bold"))+
  geom_text_repel(data=subset(caea_TNFvsUT_list, minuslogp > 18), aes(label=unique_gene_id),
                  size=4,
                  color="black",
                  nudge_y = 1,
                  force=10,
                  min.segment.length = 0,
                  max.overlaps = Inf)+
  scale_y_continuous(breaks = seq(0,325,by=25), limits = c(0,325))+
  scale_x_continuous(breaks = seq(-3,3,by=1), limits = c(-3.2,3.2))
dev.off()
```

```{r}
pdf(file="TNFdataset/Volcano_TNF_EAvsWT.pdf", width=6, height=6)
ggplot(TNF_EAvsWT_list, aes(x=log2FoldChange, y=(minuslogp)))+
  geom_point(size=2.25,color="grey", alpha=0.3)+
  geom_point(data=subset(TNF_EAvsWT_list, minuslogp > 18), size=3,color="darkred", alpha=0.6)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(),plot.background = element_blank(), axis.line = element_line()) +
  xlab("Log2FoldChange")+
  theme(axis.title = element_text(size = 12, face = "bold"), axis.text=element_text(size=10, face = "bold"))+
  ylab("-log10(p-adj)")+
  theme(axis.title = element_text(size = 12, face = "bold"), axis.text=element_text(size=10, face = "bold"))+
  geom_text_repel(data=subset(TNF_EAvsWT_list, minuslogp > 18), aes(label=unique_gene_id),
                  size=4,
                  color="black",
                  nudge_y = 1,
                  force=10,
                  min.segment.length = 0,
                  max.overlaps = Inf)+
  scale_y_continuous(breaks = seq(0,325,by=25), limits = c(0,325))+
  scale_x_continuous(breaks = seq(-3,3,by=1), limits = c(-3.2,3.2))
dev.off()
```

```{r}
pdf(file="TNFdataset/Volcano_TNF_CAEAvsEA.pdf", width=6, height=6)
ggplot(TNF_CAEAvsEA_list, aes(x=log2FoldChange, y=(minuslogp)))+
  geom_point(size=2.25,color="grey", alpha=0.3)+
  geom_point(data=subset(TNF_CAEAvsEA_list, minuslogp > 30), size=3,color="darkred", alpha=0.6)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(),plot.background = element_blank(), axis.line = element_line()) +
  xlab("Log2FoldChange")+
  theme(axis.title = element_text(size = 12, face = "bold"), axis.text=element_text(size=10, face = "bold"))+
  ylab("-log10(p-adj)")+
  theme(axis.title = element_text(size = 12, face = "bold"), axis.text=element_text(size=10, face = "bold"))+
  geom_text_repel(data=subset(TNF_CAEAvsEA_list, minuslogp > 30), aes(label=unique_gene_id),
                  size=4,
                  color="black",
                  nudge_y = 1,
                  force=10,
                  min.segment.length = 0,
                  max.overlaps = Inf)+
  scale_y_continuous(breaks = seq(0,325,by=25), limits = c(0,325))+
  scale_x_continuous(breaks = seq(-3,3,by=1), limits = c(-3.2,3.2))
dev.off()
```

### GSEA VISUALIZATIONS ###

```{r}
geneSetID_wt_TNFvsUT = match(unique(reactome_genesets_subset$gs_name), 
                                 reac_enrich_wt_TNFvsUT_GSEAobject@result[["ID"]])
geneSetID_ea_TNFvsUT = match(unique(reactome_genesets_subset$gs_name), 
                                 reac_enrich_ea_TNFvsUT_GSEAobject@result[["ID"]])
geneSetID_caea_TNFvsUT = match(unique(reactome_genesets_subset$gs_name), 
                                 reac_enrich_caea_TNFvsUT_GSEAobject@result[["ID"]])

pdf("TNFdataset/GSEA/gseaplot2_wt_TNFvsUT.pdf", width=12, height=9)
gseaplot2(reac_enrich_wt_TNFvsUT_GSEAobject, geneSetID = geneSetID_wt_TNFvsUT[!is.na(geneSetID_wt_TNFvsUT)], 
          pvalue_table = FALSE, 
          title="NFkB Signature Enrichment",
          base_size = 16,
          rel_heights = c(2,0.3,0.5))
dev.off()

pdf("TNFdataset/GSEA/gseaplot2_ea_TNFvsUT.pdf", width=12, height=9)
gseaplot2(reac_enrich_ea_TNFvsUT_GSEAobject, geneSetID = geneSetID_ea_TNFvsUT[!is.na(geneSetID_ea_TNFvsUT)], 
          pvalue_table = FALSE, 
          title="NFkB Signature Enrichment",
          base_size = 16,
          rel_heights = c(2,0.3,0.5))
dev.off()

pdf("TNFdataset/GSEA/gseaplot2_caea_TNFvsUT.pdf", width=12, height=9)
gseaplot2(reac_enrich_caea_TNFvsUT_GSEAobject, geneSetID = geneSetID_caea_TNFvsUT[!is.na(geneSetID_caea_TNFvsUT)], 
          pvalue_table = FALSE, 
          title="NFkB Signature Enrichment",
          base_size = 16,
          rel_heights = c(2,0.3,0.5))
dev.off()
```

